<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…ƒå®µç¯€çŒœç‡ˆè¬ - Lantern Festival Riddle Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            min-height: 100vh;
            min-width: 100vw;
            background: linear-gradient(135deg, #8b0000 0%, #ff4500 100%);
            background-image: url('images/background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* å±å¹•æ–¹å‘æç¤º */
        #orientation-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        #orientation-message i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        #orientation-message h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #ffd700;
        }
        
        #orientation-message p {
            font-size: 1.5rem;
            max-width: 600px;
        }

        .container {
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            padding: 10px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        header {
            text-align: center;
            padding: 5px 0;
            margin-bottom: 5px;
            position: relative;
            z-index: 2;
            flex-shrink: 0;
        }

        h1 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 2.8rem;
            color: #ffd700;
            text-shadow: 3px 3px 0 #8b0000, 6px 6px 10px rgba(0,0,0,0.5);
            margin-bottom: 5px;
            line-height: 1.1;
        }

        .subtitle {
            font-size: 1rem;
            color: #fff;
            max-width: 600px;
            margin: 0 auto;
            background-color: rgba(139, 0, 0, 0.7);
            padding: 8px 15px;
            border-radius: 15px;
            border: 2px solid #ffd700;
            line-height: 1.2;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
            border: 5px solid #ffd700;
            overflow: hidden;
        }

        /* ä¿®æ”¹è¯­è¨€é€‰æ‹©ç•Œé¢ - ç¼©å°ä¸º50vw*50vhå¹¶å±…ä¸­ */
        .language-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50vw;
            height: 50vh;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .language-selection h2 {
            font-size: 1.8rem;
            color: #8b0000;
            margin-bottom: 20px;
            text-align: center;
        }

        .language-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 70%;
        }

        .language-btn {
            width: 45%;
            height: 100%;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 4px solid transparent;
        }

        .language-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .language-btn.chinese {
            background: linear-gradient(135deg, #ff0000, #ff4500);
            color: white;
        }

        .language-btn.english {
            background: linear-gradient(135deg, #00509e, #1e90ff);
            color: white;
        }

        .language-btn i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* æ¸¸æˆè¿›è¡Œç•Œé¢ - ä¼˜åŒ–å¸ƒå±€ */
        #game-screen {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* è°œé¢˜åŒºåŸŸ - å æ®æ›´å¤šç©ºé—´ */
        .riddle-container {
            text-align: center;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff8e1;
            border-radius: 10px;
            border: 2px solid #ffd700;
            box-shadow: inset 0 0 10px rgba(255, 69, 0, 0.1);
            flex: 2; /* å æ®æ›´å¤šç©ºé—´ */
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0; /* é˜²æ­¢æº¢å‡º */
            overflow: hidden;
        }

        .riddle-text {
            color: #333;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            width: 100%;
            height: 100%;
            text-align: center;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.3;
            /* å­—ä½“å¤§å°è‡ªé€‚åº” */
            font-size: calc(1.5rem + 1vw);
            /* å“åº”å¼å­—ä½“å¤§å° */
            font-size: clamp(1.2rem, 4vw, 3rem);
        }

        /* é€‰é¡¹åŒºåŸŸ */
        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            flex: 1; /* å æ®è¾ƒå°‘ç©ºé—´ */
            min-height: 0;
        }

        .option-btn {
            padding: 15px 10px;
            font-size: 1.3rem;
            background-color: #f8f8f8;
            border: 3px solid #8b0000;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-word;
            overflow: hidden;
        }

        .option-btn:hover {
            background-color: #ffe4b5;
            transform: translateY(-3px);
        }

        .option-btn.correct {
            background-color: #32cd32 !important;
            color: white;
            border-color: #228b22;
        }

        .option-btn.wrong {
            background-color: #ff4444 !important;
            color: white;
            border-color: #cc0000;
        }

        .option-btn.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        /* æŒ‰é’®åŒºåŸŸ */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px 20px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }

        .btn-primary {
            background-color: #8b0000;
            color: white;
        }

        .btn-primary:hover {
            background-color: #ff4500;
            transform: scale(1.03);
        }

        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        /* èƒœåˆ©è§†é¢‘ */
        #victory-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1000;
            display: none;
        }

        /* æäº¤è¡¨å• */
        .submit-form {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
            text-align: center;
            overflow-y: auto;
        }

        .submit-form h2 {
            color: #8b0000;
            margin-bottom: 15px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            border-color: #8b0000;
            outline: none;
        }

        .score-display {
            font-size: 2rem;
            color: #8b0000;
            font-weight: bold;
            margin: 15px 0;
            text-align: center;
        }

        /* æ’è¡Œæ¦œå‰ä¸‰ååŒºåŸŸ */
        .top-three {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .top-three h3 {
            color: #8b0000;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .top-three-list {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .top-three-item {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            min-width: 0;
        }

        .top-three-item.rank-1 {
            border-color: #ffd700;
            order: 2;
            transform: scale(1.05);
        }

        .top-three-item.rank-2 {
            border-color: #c0c0c0;
            order: 1;
        }

        .top-three-item.rank-3 {
            border-color: #cd7f32;
            order: 3;
        }

        .rank-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .rank-1 .rank-icon {
            color: #ffd700;
        }

        .rank-2 .rank-icon {
            color: #c0c0c0;
        }

        .rank-3 .rank-icon {
            color: #cd7f32;
        }

        .top-three-item .rank {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .top-three-item .class-info {
            font-size: 1.2rem;
            font-weight: bold;
            color: #8b0000;
            margin-bottom: 5px;
        }

        .top-three-item .score {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .no-data {
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        /* æ’è¡Œæ¦œ */
        .leaderboard {
            display: none;
            background-color: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            height: 100%;
            overflow-y: auto;
        }

        .leaderboard h2 {
            color: #8b0000;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.8rem;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .leaderboard-table th, .leaderboard-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-table th {
            background-color: #8b0000;
            color: white;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .leaderboard-table tr:hover {
            background-color: #fff8e1;
        }

        .rank-1, .rank-2, .rank-3 {
            font-weight: bold;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        /* é¡µè„š - ç®€åŒ– */
        footer {
            text-align: center;
            color: white;
            padding: 5px 0;
            margin-top: 5px;
            font-size: 0.8rem;
            opacity: 0.9;
            flex-shrink: 0;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #8b0000;
        }

        /* æ¨ªå±ä¸“ç”¨æ ·å¼ */
        @media screen and (orientation: portrait) {
            #orientation-message {
                display: flex;
            }
            
            .container {
                display: none;
            }
        }

        @media screen and (orientation: landscape) and (max-height: 600px) {
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .language-selection {
                width: 60vw;
                height: 60vh;
            }
            
            .language-selection h2 {
                font-size: 1.2rem;
            }
            
            .language-btn {
                font-size: 1.2rem;
            }
            
            .language-btn i {
                font-size: 2rem;
            }
            
            .riddle-text {
                font-size: clamp(1rem, 3vw, 2rem);
                padding: 8px;
            }
            
            .option-btn {
                font-size: 1rem;
                padding: 10px 5px;
            }
            
            .top-three-list {
                flex-direction: column;
                align-items: center;
            }
            
            .top-three-item {
                width: 80%;
            }
        }

        @media screen and (min-width: 1200px) and (min-height: 700px) {
            .container {
                max-width: 1200px;
                max-height: 800px;
                padding: 20px;
            }
            
            h1 {
                font-size: 3.5rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .riddle-text {
                font-size: clamp(1.5rem, 4vw, 3.5rem);
            }
        }
    </style>
</head>
<body>
    <!-- å±å¹•æ–¹å‘æç¤º -->
    <div id="orientation-message">
        <i class="fas fa-sync-alt fa-spin"></i>
        <h2>è«‹æ—‹è½‰è¨­å‚™</h2>
        <p>å…ƒå®µç¯€çŒœç‡ˆè¬éŠæˆ²éœ€è¦åœ¨æ©«å±æ¨¡å¼ä¸‹éŠç©<br>è«‹å°‡è¨­å‚™æ—‹è½‰è‡³æ©«å‘æ¨¡å¼</p>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-lantern"></i> å…ƒå®µç¯€çŒœç‡ˆè¬</h1>
            <div class="subtitle">Lantern Festival Riddle Game</div>
        </header>

        <!-- æ¸¸æˆä¸»å®¹å™¨ -->
        <main class="game-container" id="game-container">
            <!-- è¯­è¨€é€‰æ‹©ç•Œé¢ -->
            <div class="language-selection" id="language-selection">
                <h2>è«‹é¸æ“‡éŠæˆ²èªè¨€ / Please Select Game Language</h2>
                <div class="language-options">
                    <div class="language-btn chinese" onclick="selectLanguage('chinese')">
                        <i class="fas fa-dragon"></i>
                        <span>ä¸­æ–‡ç‡ˆè¬</span>
                    </div>
                    <div class="language-btn english" onclick="selectLanguage('english')">
                        <i class="fas fa-globe"></i>
                        <span>English Riddles</span>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆè¿›è¡Œç•Œé¢ -->
            <div id="game-screen">
                <div class="riddle-container">
                    <div class="riddle-text" id="riddle-text">é€™è£¡é¡¯ç¤ºç‡ˆè¬å…§å®¹</div>
                </div>

                <div class="options-container" id="options-container">
                    <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æäº¤è¡¨å• -->
            <div class="submit-form" id="submit-form">
                <h2><i class="fas fa-trophy"></i> æŒ‘æˆ°å®Œæˆï¼</h2>
                <div class="score-display" id="final-score">45 åˆ†</div>
                
                <!-- æ’è¡Œæ¦œå‰ä¸‰ååŒºåŸŸ -->
                <div class="top-three" id="top-three">
                    <h3>ğŸ† æ’è¡Œæ¦œå‰ä¸‰å ğŸ†</h3>
                    <div class="loading" id="top-three-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>æ­£åœ¨åŠ è¼‰æ’è¡Œæ¦œæ•¸æ“š...</p>
                    </div>
                    <div class="top-three-list" id="top-three-list">
                        <!-- å‰ä¸‰åå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <p>è«‹è¼¸å…¥æ‚¨çš„ç­åˆ¥å’Œå­¸è™Ÿä»¥ç™»ä¸Šæ’è¡Œæ¦œ</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="class-select">ç­åˆ¥ Class</label>
                        <select id="class-select">
                            <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                            <!-- ç”Ÿæˆ1Aåˆ°6Eé€‰é¡¹ -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="student-id">å­¸è™Ÿ Student ID (1-30)</label>
                        <input type="number" id="student-id" min="1" max="30" placeholder="è¼¸å…¥å­¸è™Ÿ">
                    </div>
                </div>
                
                <div class="button-container">
                    <button class="btn btn-primary" onclick="submitScore()">
                        <i class="fas fa-upload"></i> æäº¤åˆ†æ•¸
                    </button>
                    <button class="btn btn-secondary" onclick="playAgain()">
                        <i class="fas fa-play"></i> å†ç©ä¸€æ¬¡
                    </button>
                </div>
            </div>
        </main>

        <!-- æ’è¡Œæ¦œ -->
        <div class="leaderboard" id="leaderboard">
            <h2><i class="fas fa-crown"></i> æ’è¡Œæ¦œ Leaderboard</h2>
            <div class="loading" id="leaderboard-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>æ­£åœ¨åŠ è¼‰æ’è¡Œæ¦œæ•¸æ“š...</p>
            </div>
            <table class="leaderboard-table" id="leaderboard-table">
                <thead>
                    <tr>
                        <th>æ’å</th>
                        <th>ç­åˆ¥</th>
                        <th>å­¸è™Ÿ</th>
                        <th>åˆ†æ•¸</th>
                        <th>ç”¨æ™‚</th>
                        <th>å€ç‡</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
            <div class="button-container" style="margin-top: 15px;">
                <button class="btn btn-primary" onclick="showGameSelection()">
                    <i class="fas fa-home"></i> è¿”å›ä¸»é¸å–®
                </button>
                <button class="btn btn-secondary" onclick="toggleLeaderboard()">
                    <i class="fas fa-times"></i> é—œé–‰æ’è¡Œæ¦œ
                </button>
            </div>
        </div>

        <!-- èƒœåˆ©è§†é¢‘ -->
        <video id="victory-video" preload="auto" loop>
            <source src="images/victory.mp4" type="video/mp4">
            æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¦–é »æ’­æ”¾ã€‚
        </video>

        <!-- é¡µè„š - ç®€åŒ– -->
        <footer>
            <p>å…ƒå®µç¯€çŒœç‡ˆè¬éŠæˆ² Â© 2023</p>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, query, orderByChild, limitToLast } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCkopSXKNpvKAyhlxaAUot2xQRlZTsnBCQ",
            authDomain: "hyp-lanterngame.firebaseapp.com",
            databaseURL: "https://hyp-lanterngame-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "hyp-lanterngame",
            storageBucket: "hyp-lanterngame.firebasestorage.app",
            messagingSenderId: "1018393426134",
            appId: "1:1018393426134:web:3cde75105b7809f949b177"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // å¯¼å‡ºåˆ°å…¨å±€ä½œç”¨åŸŸä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseQuery = query;
        window.firebaseOrderByChild = orderByChild;
        window.firebaseLimitToLast = limitToLast;
        
        console.log("Firebase åˆå§‹åŒ–å®Œæˆ");
    </script>
    
    <!-- SheetJS ç”¨äºExcelè½¬æ¢ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // æ¸¸æˆå…¨å±€å˜é‡
        let gameState = {
            language: 'chinese',
            riddles: [],
            currentRiddleIndex: 0,
            correctAnswers: 0, // è®°å½•ç­”å¯¹é¢˜æ•°
            timeUsed: 0,
            startTime: 0,
            timer: null,
            answered: false,
            gameCompleted: false
        };

        // Firebaseæ•°æ®åº“å¼•ç”¨
        let leaderboardRef = null;
        let topScoresRef = null;

        // é»˜è®¤ç¯è°œåº“ï¼ˆç©ºæ•°ç»„ï¼Œå°†ä»JSONæ–‡ä»¶åŠ è½½ï¼‰
        const defaultRiddles = {
            chinese: [],
            english: []
        };

        // å±å¹•æ–¹å‘æ£€æµ‹
        function checkOrientation() {
            const orientationMessage = document.getElementById('orientation-message');
            const container = document.querySelector('.container');
            
            if (window.innerWidth > window.innerHeight) {
                // æ¨ªå±æ¨¡å¼
                orientationMessage.style.display = 'none';
                container.style.display = 'flex';
            } else {
                // ç«–å±æ¨¡å¼
                orientationMessage.style.display = 'flex';
                container.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥å±å¹•æ–¹å‘
            checkOrientation();
            window.addEventListener('resize', checkOrientation);
            window.addEventListener('orientationchange', checkOrientation);
            
            // ç”Ÿæˆç­åˆ«é€‰é¡¹
            generateClassOptions();
            
            // åˆå§‹åŒ–Firebaseå¼•ç”¨
            if (window.firebaseRef) {
                leaderboardRef = window.firebaseRef(window.firebaseDatabase, 'leaderboard');
                topScoresRef = window.firebaseRef(window.firebaseDatabase, 'topScores');
                console.log("Firebase å¼•ç”¨å·²åˆå§‹åŒ–");
            } else {
                console.error("Firebase æœªæ­£ç¡®åˆå§‹åŒ–");
            }
            
            // æ˜¾ç¤ºè¯­è¨€é€‰æ‹©ç•Œé¢
            showLanguageSelection();
            
            // å°è¯•åŠ è½½èƒŒæ™¯å›¾ç‰‡ï¼Œå¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤èƒŒæ™¯
            const bgImage = new Image();
            bgImage.onload = function() {
                console.log('èƒŒæ™¯åœ–ç‰‡åŠ è¼‰æˆåŠŸ');
            };
            bgImage.onerror = function() {
                console.log('èƒŒæ™¯åœ–ç‰‡åŠ è¼‰å¤±æ•—ï¼Œä½¿ç”¨é»˜èªèƒŒæ™¯');
                document.body.style.backgroundImage = 'none';
            };
            bgImage.src = 'images/background.png';
        });

        // ç”Ÿæˆç­åˆ«é€‰é¡¹ (1A-6E)
        function generateClassOptions() {
            const classSelect = document.getElementById('class-select');
            const grades = ['1', '2', '3', '4', '5', '6'];
            const classes = ['A', 'B', 'C', 'D', 'E'];
            
            classSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç­åˆ¥</option>';
            
            grades.forEach(grade => {
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = `${grade}${cls}`;
                    option.textContent = `${grade}${cls}`;
                    classSelect.appendChild(option);
                });
            });
        }

        // é€‰æ‹©è¯­è¨€
        function selectLanguage(lang) {
            gameState.language = lang;
            
            // å°è¯•åŠ è½½å¯¹åº”çš„ç¯è°œåº“
            loadRiddles(lang);
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            showGameScreen();
        }

        // åŠ è½½ç¯è°œåº“
        function loadRiddles(lang) {
            // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            const storedRiddles = localStorage.getItem(`riddles_${lang}`);
            
            if (storedRiddles) {
                gameState.riddles = JSON.parse(storedRiddles);
                console.log(`å·²å¾æœ¬åœ°å­˜å„²åŠ è¼‰ ${gameState.riddles.length} å€‹${lang==='chinese'?'ä¸­æ–‡':'è‹±æ–‡'}ç‡ˆè¬`);
            } else {
                // å¦‚æœæœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æ–‡ä»¶åŠ è½½
                fetchRiddlesFromFile(lang);
            }
        }

        // ä»æ–‡ä»¶åŠ è½½ç¯è°œåº“
        function fetchRiddlesFromFile(lang) {
            const filename = lang === 'chinese' ? 'docx/chi.json' : 'docx/eng.json';
            
            fetch(filename)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç„¡æ³•åŠ è¼‰ ${filename}`);
                    }
                    return response.json();
                })
                .then(data => {
                    gameState.riddles = data;
                    console.log(`å·²å¾æ–‡ä»¶åŠ è¼‰ ${gameState.riddles.length} å€‹${lang==='chinese'?'ä¸­æ–‡':'è‹±æ–‡'}ç‡ˆè¬`);
                    
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(`riddles_${lang}`, JSON.stringify(data));
                    
                    // å¦‚æœæ¸¸æˆå·²ç»å¼€å§‹ï¼Œéœ€è¦é‡æ–°å¼€å§‹
                    if (gameState.startTime > 0) {
                        resetGame();
                        startGame();
                    }
                })
                .catch(error => {
                    console.error(`åŠ è¼‰ç‡ˆè¬åº«å¤±æ•—: ${error.message}`);
                    
                    // ä½¿ç”¨é»˜è®¤ç¯è°œåº“ï¼ˆç©ºï¼‰
                    gameState.riddles = defaultRiddles[lang];
                    
                    // å¦‚æœé»˜è®¤ç¯è°œåº“ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
                    if (gameState.riddles.length === 0) {
                        alert(`æ‰¾ä¸åˆ°${lang==='chinese'?'ä¸­æ–‡':'è‹±æ–‡'}ç‡ˆè¬åº«ï¼Œè«‹ç®¡ç†å“¡å°å…¥é¡Œç›®ã€‚`);
                        return;
                    }
                });
            
            // éšæœºé€‰æ‹©3ä¸ªç¯è°œ
            if (gameState.riddles.length > 0) {
                gameState.riddles = shuffleArray(gameState.riddles).slice(0, 3);
            }
        }

        // æ˜¾ç¤ºè¯­è¨€é€‰æ‹©ç•Œé¢
        function showLanguageSelection() {
            document.getElementById('language-selection').style.display = 'flex';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('submit-form').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
        }

        // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
        function showGameScreen() {
            document.getElementById('language-selection').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('submit-form').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'none';
            
            // å¦‚æœç¯è°œåº“ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
            if (gameState.riddles.length === 0) {
                alert(`æ‰¾ä¸åˆ°${gameState.language==='chinese'?'ä¸­æ–‡':'è‹±æ–‡'}ç‡ˆè¬åº«ï¼Œè«‹ç®¡ç†å“¡å°å…¥é¡Œç›®ã€‚`);
                return;
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetGame();
            
            // å¼€å§‹æ¸¸æˆ
            startGame();
        }

        // é‡ç½®æ¸¸æˆçŠ¶æ€
        function resetGame() {
            gameState.currentRiddleIndex = 0;
            gameState.correctAnswers = 0; // é‡ç½®ç­”å¯¹é¢˜æ•°
            gameState.timeUsed = 0;
            gameState.answered = false;
            gameState.gameCompleted = false;
            
            // æ¸…é™¤è®¡æ—¶å™¨
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameState.startTime = Date.now();
            
            // å¼€å§‹è®¡æ—¶å™¨
            gameState.timer = setInterval(() => {
                gameState.timeUsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            }, 100);
            
            // æ˜¾ç¤ºç¬¬ä¸€é“é¢˜
            displayCurrentRiddle();
        }

        // æ˜¾ç¤ºå½“å‰ç¯è°œ
        function displayCurrentRiddle() {
            const riddle = gameState.riddles[gameState.currentRiddleIndex];
            
            document.getElementById('riddle-text').textContent = riddle.question;
            
            // è°ƒæ•´å­—ä½“å¤§å°ä»¥é€‚åº”å®¹å™¨
            adjustRiddleFontSize();
            
            // ç”Ÿæˆé€‰é¡¹
            generateOptions(riddle);
            
            gameState.answered = false;
        }

        // è°ƒæ•´è°œé¢å­—ä½“å¤§å°ä»¥é€‚åº”å®¹å™¨
        function adjustRiddleFontSize() {
            const riddleText = document.getElementById('riddle-text');
            const container = riddleText.parentElement;
            
            // é‡ç½®å­—ä½“å¤§å°
            riddleText.style.fontSize = '';
            
            // è·å–å®¹å™¨å°ºå¯¸å’Œæ–‡æœ¬å°ºå¯¸
            const containerHeight = container.clientHeight;
            const containerWidth = container.clientWidth;
            
            // é€æ­¥å‡å°å­—ä½“ç›´åˆ°æ–‡æœ¬é€‚åˆå®¹å™¨
            let fontSize = 60; // åˆå§‹è¾ƒå¤§å­—ä½“
            riddleText.style.fontSize = fontSize + 'px';
            
            // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦æº¢å‡ºå®¹å™¨
            while ((riddleText.scrollHeight > containerHeight || riddleText.scrollWidth > containerWidth) && fontSize > 10) {
                fontSize -= 2;
                riddleText.style.fontSize = fontSize + 'px';
            }
        }

        // ç”Ÿæˆé€‰é¡¹
        function generateOptions(riddle) {
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            // åˆ›å»ºé€‰é¡¹æ•°ç»„ï¼ˆæ­£ç¡®ç­”æ¡ˆ+å¹²æ‰°é¡¹ï¼‰
            let options = [riddle.answer, ...riddle.distractors];
            options = shuffleArray(options);
            
            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option;
                button.onclick = () => selectOption(option, button, riddle.answer);
                optionsContainer.appendChild(button);
            });
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(selected, button, correctAnswer) {
            if (gameState.answered) return;
            
            if (selected === correctAnswer) {
                // æ­£ç¡®ç­”æ¡ˆ
                gameState.answered = true;
                gameState.correctAnswers++; // å¢åŠ ç­”å¯¹é¢˜æ•°
                button.classList.add('correct');
                
                // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach(btn => {
                    btn.classList.add('disabled');
                });
                
                // å»¶è¿Ÿåè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
                setTimeout(() => {
                    nextRiddle();
                }, 1000);
            } else {
                // é”™è¯¯ç­”æ¡ˆ
                button.classList.add('wrong');
                button.classList.add('disabled'); // ç¦ç”¨é”™è¯¯é€‰é¡¹
            }
        }

        // ä¸‹ä¸€é¢˜
        function nextRiddle() {
            gameState.currentRiddleIndex++;
            
            if (gameState.currentRiddleIndex < gameState.riddles.length) {
                // æ˜¾ç¤ºä¸‹ä¸€é¢˜
                displayCurrentRiddle();
            } else {
                // æ¸¸æˆç»“æŸ
                endGame();
            }
        }

        // ç»“æŸæ¸¸æˆ
        function endGame() {
            clearInterval(gameState.timer);
            gameState.gameCompleted = true;
            
            // è®¡ç®—æœ€ç»ˆåˆ†æ•°
            const finalScore = calculateFinalScore();
            
            // æ˜¾ç¤ºèƒœåˆ©è§†é¢‘
            showVictoryVideo();
            
            // å»¶è¿Ÿæ˜¾ç¤ºæäº¤è¡¨å•
            setTimeout(() => {
                showFinalScore(finalScore);
            }, 3000);
        }

        // è®¡ç®—æœ€ç»ˆåˆ†æ•°
        function calculateFinalScore() {
            // è®¡ç®—å€ç‡ï¼šåˆå§‹å€ç‡30ï¼Œæ¯ç»è¿‡1ç§’ï¼Œå€ç‡é™ä½0.5
            const multiplier = Math.max(0, 30 - (gameState.timeUsed * 0.5));
            
            // è®¡ç®—åˆ†æ•°ï¼šç­”å¯¹é¢˜æ•° Ã— 15åˆ† Ã— å€ç‡
            const score = Math.round(gameState.correctAnswers * 15 * multiplier);
            
            return {
                score: score,
                multiplier: multiplier,
                timeUsed: gameState.timeUsed,
                correctAnswers: gameState.correctAnswers
            };
        }

        // æ˜¾ç¤ºæœ€ç»ˆåˆ†æ•°
        function showFinalScore(finalScore) {
            const scoreText = gameState.language === 'chinese' 
                ? `${finalScore.score} åˆ†` 
                : `${finalScore.score} points`;
            document.getElementById('final-score').textContent = scoreText;
            
            // æ˜¾ç¤ºæ’è¡Œæ¦œå‰ä¸‰å
            displayTopThree();
            
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('submit-form').style.display = 'block';
        }

        // æ˜¾ç¤ºèƒœåˆ©è§†é¢‘
        function showVictoryVideo() {
            const video = document.getElementById('victory-video');
            video.style.display = 'block';
            video.play().catch(e => {
                console.log('è¦–é »æ’­æ”¾å¤±æ•—:', e);
                video.style.display = 'none';
            });
            
            // è§†é¢‘æ’­æ”¾3ç§’åéšè—
            setTimeout(() => {
                video.style.display = 'none';
                video.pause();
                video.currentTime = 0;
            }, 3000);
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œå‰ä¸‰åï¼ˆä»Firebaseè·å–ï¼‰
        function displayTopThree() {
            const topThreeList = document.getElementById('top-three-list');
            const topThreeLoading = document.getElementById('top-three-loading');
            
            topThreeList.innerHTML = '';
            topThreeLoading.style.display = 'block';
            
            if (!leaderboardRef) {
                topThreeLoading.style.display = 'none';
                topThreeList.innerHTML = '<div class="no-data">Firebase æœªæ­£ç¢ºåˆå§‹åŒ–</div>';
                return;
            }
            
            // ä»Firebaseè·å–æ•°æ®ï¼ŒæŒ‰åˆ†æ•°æ’åºï¼Œé™åˆ¶å‰3å
            const topScoresQuery = window.firebaseQuery(
                leaderboardRef, 
                window.firebaseOrderByChild('score'), 
                window.firebaseLimitToLast(3)
            );
            
            window.firebaseOnValue(topScoresQuery, (snapshot) => {
                topThreeLoading.style.display = 'none';
                const data = snapshot.val();
                
                if (!data) {
                    topThreeList.innerHTML = '<div class="no-data">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“š</div>';
                    return;
                }
                
                // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆé™åºï¼‰
                const leaderboardArray = [];
                for (const key in data) {
                    leaderboardArray.push({
                        id: key,
                        ...data[key]
                    });
                }
                
                // æŒ‰åˆ†æ•°é™åºæ’åº
                leaderboardArray.sort((a, b) => b.score - a.score);
                
                // åªå–å‰ä¸‰å
                const topThree = leaderboardArray.slice(0, 3);
                
                if (topThree.length === 0) {
                    topThreeList.innerHTML = '<div class="no-data">æš«ç„¡æ’è¡Œæ¦œæ•¸æ“š</div>';
                    return;
                }
                
                // æ˜¾ç¤ºå‰ä¸‰å
                const ranks = [
                    { class: 'rank-1', icon: 'ğŸ¥‡', label: 'ç¬¬ä¸€å' },
                    { class: 'rank-2', icon: 'ğŸ¥ˆ', label: 'ç¬¬äºŒå' },
                    { class: 'rank-3', icon: 'ğŸ¥‰', label: 'ç¬¬ä¸‰å' }
                ];
                
                topThree.forEach((entry, index) => {
                    const rank = ranks[index];
                    const item = document.createElement('div');
                    item.className = `top-three-item ${rank.class}`;
                    
                    item.innerHTML = `
                        <div class="rank-icon">${rank.icon}</div>
                        <div class="rank">${rank.label}</div>
                        <div class="class-info">${entry.class} - ${entry.studentId}</div>
                        <div class="score">${entry.score} åˆ†</div>
                    `;
                    
                    topThreeList.appendChild(item);
                });
                
                // å¦‚æœä¸è¶³3åï¼Œè¡¥å……ç©ºä½
                for (let i = topThree.length; i < 3; i++) {
                    const rank = ranks[i];
                    const item = document.createElement('div');
                    item.className = `top-three-item ${rank.class}`;
                    item.style.opacity = '0.5';
                    
                    item.innerHTML = `
                        <div class="rank-icon">${rank.icon}</div>
                        <div class="rank">${rank.label}</div>
                        <div class="class-info">---</div>
                        <div class="score">--- åˆ†</div>
                    `;
                    
                    topThreeList.appendChild(item);
                }
            }, (error) => {
                topThreeLoading.style.display = 'none';
                topThreeList.innerHTML = `<div class="no-data">åŠ è¼‰å¤±æ•—: ${error.message}</div>`;
                console.error("Firebase è®€å–éŒ¯èª¤:", error);
            });
        }

        // æäº¤åˆ†æ•°
        function submitScore() {
            const classSelect = document.getElementById('class-select');
            const studentId = document.getElementById('student-id').value;
            
            if (!classSelect.value || !studentId) {
                alert(gameState.language === 'chinese' 
                    ? 'è«‹é¸æ“‡ç­åˆ¥ä¸¦è¼¸å…¥å­¸è™Ÿ' 
                    : 'Please select class and enter student ID');
                return;
            }
            
            // è®¡ç®—æœ€ç»ˆåˆ†æ•°
            const finalScore = calculateFinalScore();
            
            // æ·»åŠ åˆ°æ’è¡Œæ¦œ
            addToLeaderboard(classSelect.value, studentId, finalScore.score, finalScore.timeUsed, finalScore.multiplier);
            
            // æ˜¾ç¤ºæ’è¡Œæ¦œ
            document.getElementById('submit-form').style.display = 'none';
            document.getElementById('leaderboard').style.display = 'block';
            
            // é‡ç½®è¡¨å•
            classSelect.value = '';
            document.getElementById('student-id').value = '';
        }

        // æ·»åŠ åˆ°æ’è¡Œæ¦œï¼ˆä¿å­˜åˆ°Firebaseï¼‰
        function addToLeaderboard(className, studentId, score, time, multiplier) {
            if (!leaderboardRef) {
                alert('Firebase æœªæ­£ç¢ºåˆå§‹åŒ–ï¼Œç„¡æ³•æäº¤åˆ†æ•¸');
                return;
            }
            
            // åˆ›å»ºæ–°è®°å½•
            const newScoreRef = window.firebasePush(leaderboardRef);
            
            window.firebaseSet(newScoreRef, {
                class: className,
                studentId: studentId,
                score: score,
                time: time,
                multiplier: multiplier,
                timestamp: Date.now(),
                language: gameState.language
            }).then(() => {
                console.log("åˆ†æ•¸å·²æˆåŠŸæäº¤åˆ° Firebase");
                // åˆ·æ–°æ’è¡Œæ¦œæ˜¾ç¤º
                loadLeaderboard();
            }).catch((error) => {
                console.error("æäº¤åˆ†æ•¸åˆ° Firebase å¤±æ•—:", error);
                alert('æäº¤åˆ†æ•¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            });
        }

        // åŠ è½½æ’è¡Œæ¦œæ•°æ®ï¼ˆä»Firebaseï¼‰
        function loadLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboard-body');
            const leaderboardLoading = document.getElementById('leaderboard-loading');
            const leaderboardTable = document.getElementById('leaderboard-table');
            
            leaderboardBody.innerHTML = '';
            leaderboardLoading.style.display = 'block';
            leaderboardTable.style.display = 'none';
            
            if (!leaderboardRef) {
                leaderboardLoading.style.display = 'none';
                leaderboardBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 30px; text-align: center; color: #666; font-style: italic;">
                            Firebase æœªæ­£ç¢ºåˆå§‹åŒ–
                        </td>
                    </tr>
                `;
                leaderboardTable.style.display = 'table';
                return;
            }
            
            // ä»Firebaseè·å–æ•°æ®ï¼ŒæŒ‰åˆ†æ•°æ’åº
            const leaderboardQuery = window.firebaseQuery(
                leaderboardRef, 
                window.firebaseOrderByChild('score')
            );
            
            window.firebaseOnValue(leaderboardQuery, (snapshot) => {
                leaderboardLoading.style.display = 'none';
                leaderboardTable.style.display = 'table';
                
                const data = snapshot.val();
                
                if (!data) {
                    leaderboardBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 30px; text-align: center; color: #666; font-style: italic;">
                                æš«ç„¡æ’è¡Œæ¦œæ•¸æ“š
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆé™åºï¼‰
                const leaderboardArray = [];
                for (const key in data) {
                    leaderboardArray.push({
                        id: key,
                        ...data[key]
                    });
                }
                
                // æŒ‰åˆ†æ•°é™åºæ’åº
                leaderboardArray.sort((a, b) => b.score - a.score);
                
                // åªä¿ç•™å‰20å
                const topScores = leaderboardArray.slice(0, 20);
                
                leaderboardBody.innerHTML = '';
                
                topScores.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    
                    // æ·»åŠ æ’åç±»
                    if (index === 0) row.classList.add('rank-1');
                    else if (index === 1) row.classList.add('rank-2');
                    else if (index === 2) row.classList.add('rank-3');
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.class}</td>
                        <td>${entry.studentId}</td>
                        <td>${entry.score}</td>
                        <td>${entry.time}ç§’</td>
                        <td>${entry.multiplier.toFixed(1)}</td>
                    `;
                    
                    leaderboardBody.appendChild(row);
                });
            }, (error) => {
                leaderboardLoading.style.display = 'none';
                leaderboardTable.style.display = 'table';
                leaderboardBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 30px; text-align: center; color: #ff4444; font-style: italic;">
                            åŠ è¼‰å¤±æ•—: ${error.message}
                        </td>
                    </tr>
                `;
                console.error("Firebase è®€å–éŒ¯èª¤:", error);
            });
        }

        // åˆ‡æ¢æ’è¡Œæ¦œæ˜¾ç¤º
        function toggleLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            
            if (leaderboard.style.display === 'block') {
                leaderboard.style.display = 'none';
                showLanguageSelection();
            } else {
                leaderboard.style.display = 'block';
                document.getElementById('language-selection').style.display = 'none';
                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('submit-form').style.display = 'none';
                
                // åŠ è½½æ’è¡Œæ¦œæ•°æ®
                loadLeaderboard();
            }
        }

        // é‡æ–°å¼€å§‹æ¸¸æˆ
        function restartGame() {
            if (confirm(gameState.language === 'chinese' 
                ? 'ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦å°‡æœƒä¸Ÿå¤±ã€‚' 
                : 'Are you sure you want to restart? Your current progress will be lost.')) {
                resetGame();
                startGame();
            }
        }

        // å†ç©ä¸€æ¬¡
        function playAgain() {
            document.getElementById('submit-form').style.display = 'none';
            showLanguageSelection();
        }

        // è¿”å›æ¸¸æˆé€‰æ‹©
        function showGameSelection() {
            document.getElementById('leaderboard').style.display = 'none';
            showLanguageSelection();
        }

        // å·¥å…·å‡½æ•°ï¼šæ‰“ä¹±æ•°ç»„é¡ºåº
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
    </script>
</body>
</html>
